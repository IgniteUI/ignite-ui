<!DOCTYPE html>
<html>
    <head>
        <title>Html Editor Tests</title>
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/themes/infragistics/infragistics.theme.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.shared.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.popover.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.toolbarbutton.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.splitbutton.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.colorpicker.css" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.combo.css" media="screen" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.editors.css" media="screen" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.htmleditor.css" media="screen" />
        <link type="text/css" rel="stylesheet" href="../../../../../src/css/structure/modules/infragistics.ui.toolbar.css" media="screen" />
        <link type="text/css" href="../../../../../bower_components/qunit/qunit/qunit.css" rel="stylesheet" media="screen" />
        <script type="text/javascript" src="../../../../../bower_components/jquery/dist/jquery.js"></script>
        <script type="text/javascript" src="../../../../../bower_components/jquery-tmpl/jquery.tmpl.js"></script>
        <script type="text/javascript" src="../../../../../bower_components/jquery-ui/jquery-ui.js"></script>
        <script type="text/javascript" src="../../../../../bower_components/qunit/qunit/qunit.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.util.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.util.jquery.js"></script>
	    <script type="text/javascript" src="../../../../../src/js/modules/infragistics.util.jquerydeferred.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.shared.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.templating.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.popover.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.toolbarbutton.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.toolbar.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.splitbutton.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.colorpicker.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.colorpickersplitbutton.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.datasource.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.combo.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/i18n/infragistics.ui.toolbar-en.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/i18n/infragistics.ui.htmleditor-en.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.htmleditor.js"></script>
        <script type="text/javascript" src="../../../../../src/js/modules/infragistics.ui.editors.js"></script>
        <script type="text/javascript" src="../../../common/test-util.js"></script>
        <script type="text/javascript">
            var equalWithEpsilon = function (a, b, epsilon) {
                return Math.abs(a - b) < epsilon;
            }

            var htmlEditorTestBeds = {
                htmlEditorId: "html1",
                secondHtmlEditorId: "htmlEditorSetInitOptions",
                keyboardHtmlEditorId: "keyboardInteractionEditor",
                adjustSourceButtonsEditorId: "adjustSourceButtonsEditor",
                setup: function () {
                    $('<div id="' + this.htmlEditorId + '"></div>')
                        .appendTo(document.body)
                        .igHtmlEditor();

                    $('<div id="' + this.secondHtmlEditorId + '"></div>')
                        .appendTo(document.body)
                        .igHtmlEditor({
                            showCopyPasteToolbar: false,
                            toolbarSettings: [
                            {
                                name: "textToolbar",
                                isExpanded: false,
                                isBold: true,
                            }]
                        });

                    $('<div id="' + this.keyboardHtmlEditorId + '"></div>')
                        .appendTo(document.body)
                        .igHtmlEditor({
                            value: "<table border='1'><tr><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></table>"
                        });

                    $('<br />')
                        .appendTo(document.body);

                    $('<div id="' + this.adjustSourceButtonsEditorId + '"></div>')
                        .appendTo(document.body)
                        .igHtmlEditor();
                },
                teardown: function () {
                    $("#" + this.htmlEditorId).igHtmlEditor('destroy').remove();
                    $("#" + this.secondHtmlEditorId).igHtmlEditor('destroy').remove();
                    $("#" + this.keyboardHtmlEditorId).igHtmlEditor('destroy').remove();
                    $("#" + this.adjustSourceButtonsEditorId).igHtmlEditor('destroy').remove();
                },
                areDefaultToolbarsRendered: function () {
                    var toolbarsContainer = this.htmlEditorId + "_toolbars";
                    var toolbars = $('#' + toolbarsContainer).children();

                    equal(toolbars.length, 4, 'All default toolbars are rendered.');
                    toolbars.each(function (i, e) {
                        ok($(e).hasClass("ui-widget ui-widget-content ui-igtoolbar ui-corner-all"), "The element (" + e.id + ") have all expected classes.");
                    });

                },
                areTextToolbarItemsRendered: function () {
                    var textToolbarItemsID = this.htmlEditorId + "_toolbars_textToolbar_toolbar_buttons";
                    var toolbarItems = $("#" + textToolbarItemsID).children();
                    var css = "ui-button-icon-only ui-button ui-igbutton ui-widget ui-widget-content ui-corner-all ui-state-default";

                    equal(toolbarItems.length, 7, 'All Text toolbar items are rendered.');
                    toolbarItems.each(function (i, e) {
                        if ($(e).is(":ui-igCombo")) {
                            css = "ui-igcombo-wrapper";
                            if ($(e).hasClass("ui-combo-fontfamily")) {
                                css += " ui-combo-fontfamily";
                            }
                        }
                        ok($(e).hasClass(css), "The element (" + e.id + ") have all expected classes.");
                    });

                },
                areFormattingToolbarItemsRendered: function () {
                    var formattingToolbarItemsID = this.htmlEditorId + "_toolbars_formattingToolbar_toolbar_buttons";
                    var toolbarItems = $("#" + formattingToolbarItemsID).children();
                    var css = "ui-button-icon-only ui-button ui-igbutton ui-widget ui-widget-content ui-corner-all ui-state-default";

                    equal(toolbarItems.length, 10, 'All Formatting toolbar items are rendered.');
                    toolbarItems.each(function (i, e) {
                        if ($(e).is(":ui-igSplitButton") || $(e).is(":ui-igColorPickerSplitButton")) {
                            css = "ui-splitbutton ui-widget";
                        }
                        //console.log(e.id, $(e).is(":ui-igSplitButton") || $(e).is(":ui-igColorPickerSplitButton"), css);
                        ok($(e).hasClass(css), "The element (" + e.id + ") have all expected classes.");
                    });
                },
                areInsertObjectToolbarItemsRendered: function () {
                    var insertObjectToolbarItemsID = this.htmlEditorId + "_toolbars_insertObjectToolbar_toolbar_buttons";
                    var toolbarItems = $("#" + insertObjectToolbarItemsID).children();
                    var css = "ui-button-icon-only ui-button ui-igbutton ui-widget ui-widget-content ui-corner-all ui-state-default";

                    equal(toolbarItems.length, 7, 'All Insert Object toolbar items are rendered.');
                    toolbarItems.each(function (i, e) {
                        ok($(e).hasClass(css), "The element (" + e.id + ") have all expected classes.");
                    });
                },
                areCopyPasteToolbarItemsRendered: function () {
                    var copyPasteToolbarItemsID = this.htmlEditorId + "_toolbars_copyPasteToolbar_toolbar_buttons";
                    var toolbarItems = $("#" + copyPasteToolbarItemsID).children();
                    var css = "ui-button-icon-only ui-button ui-igbutton ui-widget ui-widget-content ui-corner-all ui-state-default";

                    equal(toolbarItems.length, 5, 'All "Copy/paste" toolbar items are rendered.');
                    toolbarItems.each(function (i, e) {
                        ok($(e).hasClass(css), "The element (" + e.id + ") have all expected classes.");
                    });
                },
                isToolabrExpandable: function (toolbarId) {
                    var toolabrCollapseButton = this.htmlEditorId + "_toolbars_" + toolbarId + "_collapseButton";
                    var toolbar = $("#" + this.htmlEditorId + "_toolbars_" + toolbarId);
                    var toolbarWidth = toolbar.width();
                    var epsilon = 3; //px

                    $("#" + toolabrCollapseButton).click();

                    stop();
                    setTimeout(function () {
                        start();
                    }, 100);

                    toolbar.bind("igtoolbarexpanded", function () {
                        ok(equalWithEpsilon(toolbar.width(), toolbarWidth, epsilon), "The " + toolbarId + " toolbar is expanded.");
                        start();
                    });
                    stop();
                    $("#" + toolabrCollapseButton).click();
                },
                isToolbarCollapsible: function (toolbarId) {
                    var toolabrCollapseButton = this.htmlEditorId + "_toolbars_" + toolbarId + "_collapseButton";
                    var toolbar = $("#" + this.htmlEditorId + "_toolbars_" + toolbarId);
                    var toolbarWidth = toolbar.width();
                    var epsilon = 3; //px

                    stop();
                    setTimeout(function () {
                        start();
                    }, 100);

                    toolbar.bind("igtoolbarcollapsed", function () {
                        ok(equalWithEpsilon(toolbar.width(), toolbar.height(), epsilon), "The " + toolbarId + " toolbar is collapsed.");
                        start();
                    });
                    stop();
                    $("#" + toolabrCollapseButton).click();
                },
                isContentAreaRenderedProperly: function () {
                    var iframe = $("#" + this.htmlEditorId + "_editor"),
                        textArea = $("#" + this.htmlEditorId + "_source"),
                        htmlEditor = $('#' + this.htmlEditorId);
                    htmlEditorWidth = htmlEditor.igHtmlEditor("option", "width"),
                        htmlEditorHeight = htmlEditor.igHtmlEditor("option", "height");
                    ok(iframe.height() < htmlEditorHeight && (iframe.width() > 0 && iframe.width() <= htmlEditorWidth), "HTML editor design view is rendered.");
                    ok(textArea.length && textArea.width() && textArea.height(), "HTML editor source view is rendered.");
                },
                initialContentRendering: function () {
                    var id = 'htmlEditorId1',
                        content = '<p>Some text</p><ul><li>list 1</li><li>list 2</li></ul><div>Something in a div</div>';
                    $('<div id="' + id + '" />').append(content).appendTo('body');
                    $('#' + id).igHtmlEditor();
                    equal($('#' + id).igHtmlEditor('getContent', 'html'), content, 'The initial content was not rendered in the HTML Editor.');
                    var newContent = '<div><span>text 1</span><span>text 2</span><table><tbody><tr><td>Cell 1</td><td>Cell 2</td></tr></tbody></table></div>';
                    $('#' + id).igHtmlEditor('setContent', newContent, 'html');
                    equal($('#' + id).igHtmlEditor('getContent', 'html'), newContent, 'The set content method did not function properly.');

                    // Check if the editor contents were modified or not
                    equal($('#' + id).igHtmlEditor('isDirty'), false, 'The editor contents werent modified');

                    // Set text content
                    var newTextContent = 'Some new text content'
                    $('#' + id).igHtmlEditor('setContent', newTextContent, 'text');
                    equal($('#' + id).igHtmlEditor('getContent', 'text'), newTextContent, 'The set content method did not function properly.');
                },
                modifyInitiallySetOptions: function () {
                    var htmlEditor = $('#' + this.secondHtmlEditorId);

                    // Check toolbarSettings initial existance
                    equal(htmlEditor.igHtmlEditor("option", "toolbarSettings").length, 1, "toolbarSettings are not set.");

                    htmlEditor.igHtmlEditor("option", "value", "Set and modify toolbar settings");
                    htmlEditor.igHtmlEditor("option", "height", 400);
                    htmlEditor.igHtmlEditor("option", "width", 700);
                    htmlEditor.igHtmlEditor("option", "showFormattingToolbar", true);
                    htmlEditor.igHtmlEditor("option", "showCopyPasteToolbar", false);
                    htmlEditor.igHtmlEditor("option", "toolbarSettings", [
                        {
                            name: "textToolbar",
                            isExpanded: true
                        },
                        {
                            name: "copyPasteToolbar",
                            isExpanded: false
                        }]);

                    htmlEditor.igHtmlEditor("option", "value", undefined);

                    // Check some options that werent set initially (_setOption function)
                    equal(htmlEditor.igHtmlEditor("option", "value"), "Set and modify toolbar settings", "Value options is correctly set");
                    equal(htmlEditor.igHtmlEditor("option", "toolbarSettings").length, 2, "toolbarSettings changed successfully");
                    equal(htmlEditor.igHtmlEditor("option", "height"), 400, "height changed sucessfully");
                    equal(htmlEditor.igHtmlEditor("option", "width"), 700, "height changed sucessfully");
                    equal(htmlEditor.igHtmlEditor("option", "showFormattingToolbar"), true, "showFormattingToolbar is set to true");
                    equal(htmlEditor.igHtmlEditor("option", "showCopyPasteToolbar"), false, "showCopyPasteToolbar is set to false");

                    // Check text toolbar custom settings
                    equal($('#htmlEditorSetInitOptions').data().igHtmlEditor._allToolbars[0].items[0].settings.props.isBold.value, true, "isBold Text Toolbar item is set to true");
                },
                focuseIframeIEBrowserNodeTypeCheck: function () {
                    // Set browser to be IE
                    $.ig.util.isIE = true;

                    var htmlEditor = $('#' + this.htmlEditorId),
                        htmlElement = $(htmlEditor.igHtmlEditor("contentEditable")).parent();

                    stop();
                    setTimeout(function(){
                        start();
                    }, 100);

                    // Workspace document click and mouseup
                    // Simulate iframe to be focused
                    htmlElement.trigger("click");
                    htmlElement.trigger("mouseup");

                    equal($('#' + this.htmlEditorId).igHtmlEditor("isDirty"), true, "Iframe was not focused and isDirty isn't set to true");
                },
                executeCommandIeBrowserNodeTypeTextCheck: function() {
                    // Set browser to be IE version - 10
                    $.ig.util.isIE = true;
                    $.ig.util.browserVersion = 10;

                    this.callback = function (iframeBody) {
                        return ((this.css("fontWeight") === "bold" ||
                                this.css("fontWeight") === "700") ||
                            (this.find("strong:only-child").length) //IE
                            ||
                            (this.children().first().css("fontWeight") === "bold")
                        );
                    };

                    this.htmlEditor = $('#' + this.htmlEditorId);
                    this.editorDocument = this.htmlEditor.find("iframe").contents();

                    // Append samo content to the iframe
                    var content = '<p>Some text</p><ul><li>list 1</li><li>list 2</li></ul><div>Something in a div</div>';
                    $(this.htmlEditor.igHtmlEditor("contentEditable")).append(content);

                    // Get the second p tag that the nodeType is text
                    var p = $(this.htmlEditor.igHtmlEditor("contentEditable")).find("p:nth-child(2)");

                    var self = this;
                    stop();
                    setTimeout(function(){
                        // Select given p element
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        // Bold the selected element
                        self.htmlEditor.igHtmlEditor("executeAction", "Bold");
                        // Check if selected element has the correct style
                        var condition = self.callback.call(p, self.editorDocument.find("body"));

                        equal(condition, true, "Selected element was not affected after execution of the command!")
                        start();
                    }, 100);
                },
                executeCommandIeBrowserNodeTypeNotTextCheck: function () {
                    // Set browser to be IE version - 10
                    $.ig.util.isIE = true;
                    $.ig.util.browserVersion = 10;

                    // Selection type after updateSelection operation.
                    this.selectionType = "Caret";

                    this.htmlEditor = $('#' + this.htmlEditorId);
                    this.editorDocument = this.htmlEditor.find("iframe").contents();

                    // Get first p tag that the nodeType is element.
                    var p = $(this.htmlEditor.igHtmlEditor("contentEditable")).find("p:first");

                    var self = this;
                    stop();
                    setTimeout(function(){
                        // Select given p element
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        // Bold the selected element
                        self.htmlEditor.igHtmlEditor("executeAction", "Underline");
                        // Get selection type
                        var getSelectionType = self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved._selection.type;

                        deepEqual(getSelectionType, self.selectionType, "Selection type was not changed after command execution.")
                        start();
                    }, 100);
                },
                keyboardInteractions: function () {
                    var self = this, htmlEditor = $('#' + this.keyboardHtmlEditorId),
                        iframe = $("#" + this.keyboardHtmlEditorId).find("#" + this.keyboardHtmlEditorId + "_editor"),
                        viewStateBtn = htmlEditor.find(".ui-igbutton-viewsource"),
                        htmlElement = $($("#" + this.secondHtmlEditorId).igHtmlEditor("contentEditable")).parent(),
                        focusedElement;

                    viewStateBtn.click();

                    stop();
                    setTimeout(function () {
                        start();
                    }, 100);

                    // Check if the edit source is hidden and view source is shown
                    equal(iframe.is(":visible"), false, "View source mode on");

                    viewStateBtn.click();

                    stop();
                    setTimeout(function () {
                        htmlEditor.data("igHtmlEditor")._resizeWorkspaceHandler()
                        start();
                    }, 100);


                    // Check if the edit source is shown and view source is hidden
                    equal(iframe.is(":visible"), true, "View source mode off");

                    // Workspace document click and mouseup
                    // Simulate iframe to be focused
                    htmlElement.trigger("click");
                    htmlElement.trigger("mouseup");

                    equal($('#' + this.secondHtmlEditorId).igHtmlEditor('isDirty'), true, 'Iframe was focused and isDirty is set to true');

                    // Simulate keydown of backspace event
                    var backspaceClickEvent = jQuery.Event("keydown", { keyCode: 8 });

                    // Simulate keydown of backspace event
                    var ctrlAndZClickEvent = jQuery.Event("keydown", { ctrlKey: true, which: 90 });

                    htmlElement.trigger(backspaceClickEvent);
                    htmlElement.trigger(ctrlAndZClickEvent);

                    equal($("#" + this.htmlEditorId).igHtmlEditor("getContent", "html"), '<p><br></p>', 'Prevent deletion by clicking backspace or delete btn when the p has only <br> in it');
                },
                insertAtCaretPosition: function(){
                    var htmlEditor = $('#' + this.htmlEditorId),
                        htmlElement = $(htmlEditor.igHtmlEditor("contentEditable")).parent(),
                        contentToSelect;
                    stop();
                    setTimeout(function(){
                        htmlElement.click();
                        htmlEditor.igHtmlEditor('setContent', '<div>Some text.</div>', 'html');
                        start();
                    }, 300);


                    stop();
                    setTimeout(function(){
                        htmlElement.click();
                        htmlEditor.igHtmlEditor('setContent', '<div>Some text.</div>', 'html');
                        start();
                    }, 500);

                    stop();
                    setTimeout(function () {
                        contentToSelect = $(htmlEditor.igHtmlEditor("contentEditable")).parent().find("body");
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(contentToSelect.contents());
                        start();
                    }, 600);

                    stop();
                    setTimeout(function(){
                        htmlEditor.igHtmlEditor("insertAtCaret", jQuery('<div/>', {
                                                    id: 'divElement',
                                                    text: 'Add new text!'
                                                }));

                        // Process only Dom objects, jQuery objects or strings
                        htmlEditor.igHtmlEditor("insertAtCaret", 4 );
                        equal(htmlEditor.igHtmlEditor("getContent", "text"), "Add new text!Some text.", "Correctly inserted at caret position");
                        start();
                    }, 700);
                },
                adjustDomPathToolbarWidth: function(){
                    var htmlEditor1 = $('#' + this.adjustSourceButtonsEditorId), contentToSelect,
                    htmlElement = $($(htmlEditor1).igHtmlEditor("contentEditable")).parent(),
                    combo = $("#" + this.adjustSourceButtonsEditorId + "_toolbars_textToolbar_item_fontFamily")
                    .igCombo("option", {
                            animationShowDuration: 0,
                            animationHideDuration: 0
                    });

                    combo.bind("igcombodropdownopened", function () {
                        combo.igCombo('index', 3, null, true);
                    });

                    htmlEditor1.igHtmlEditor("setContent", "<div><div><div><div><div><div><div><div><div><span style='font-weight: bold;'>Lorem ipsum&nbsp;</span><br></div>dolor sit amet, choro quaestio no pro, assum bonorum et sit. Esse pertinax platonem pri ea, suas probo deserunt est ad, te eam consul docendi. Nec omnes vituperata no. Ex sint nullam integre<div><div><div><div><div><div> <b>vis, ex duis aliquip euripidis est. <div><div><div><div><div><div> <i>Case facer et eos. Affert omittantur</i></div><div></div></div></div></div></div></div> pro in.</b></div><div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>" , 'html');
                    htmlEditor1.igHtmlEditor("option", "width", 670);

                    stop();
                    setTimeout(function () {
                        contentToSelect = $(htmlEditor1.igHtmlEditor("contentEditable")).parent().find("body i");
                        htmlEditor1.data("igHtmlEditor")._selectionWrapperSaved.select(contentToSelect.contents());

                        htmlEditor1.igHtmlEditor("insertAtCaret", jQuery('<div/>', {
                                                    id: 'divElement',
                                                    text: 'Add new text!'
                                                }));

                        combo.igCombo("openDropDown", null, true, true);

                        start();
                    }, 100);

                    $("#" + this.adjustSourceButtonsEditorId + "_toolbars_textToolbar").bind("igtoolbartoolbarcomboselected", function (e) {
                        stop();
                        setTimeout(function () {
                            combo.igCombo("closeDropDown");
                            start();
                        }, 400);

                        stop();
                        setTimeout(function () {
                            ok($(".ui-igpathfinder-overflowMarker").length !== 0, "When the maximum width is reached, remove the last added button, and add the overflow marker.");
                            start();
                        }, 600);

                        stop();
                        setTimeout(function () {
                            $("#adjustSourceButtonsEditor_domPathToolbar").find("div:nth-child(2)").trigger("mouseover");
                            $("#adjustSourceButtonsEditor_domPathToolbar").find("div:nth-child(2)").trigger("mouseleave");
                            start();
                        }, 700);
                    });
                }
            };

            var htmlEditorInteractionTests = {
                p: null,
                htmlEditorId: "html1",
                htmlEditor: null,
                editorBody: null,
                secondHtmlEditorId: "htmlEditorSetInitOptions",
                setup: function () {
                    var editorDocument,
                        self = this;

                    this.htmlEditor = $('<div id="' + this.htmlEditorId + '"></div>');

                    this.htmlEditor.appendTo(document.body)
                        .igHtmlEditor({
                            rendered: function () {
                                editorDocument = self.htmlEditor.find("iframe").contents(),
                                    self.editorBody = editorDocument.find("body");
                                self.editorBody.empty().append($("<p>test</p>", editorDocument[0]));
                            }
                        });
                },
                teardown: function () {
                    $("#" + this.htmlEditorId).igHtmlEditor('destroy').remove();
                },
                bold: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return ((this.css("fontWeight") === "bold" ||
                                this.css("fontWeight") === "700") ||
                            (this.find("strong:only-child").length) //IE
                            ||
                            (this.children().first().css("fontWeight") === "bold")
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("Bold", callback);
                    } else {
                        this._testToolbarButtonClick("Bold", "", "textToolbar", callback);
                    }
                },
                italic: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return ((this.css("fontStyle") === "italic") ||
                            ((this.find("em:only-child"))) ||
                            (this.children().first().css("fontStyle") === "italic")
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("Italic", callback);
                    } else {
                        this._testToolbarButtonClick("Italic", "", "textToolbar", callback);
                    }
                },
                undelined: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return ((this.css("textDecoration") === "underline") ||
                            (this.children().first().css("textDecoration") === "underline") ||
                            ((this.find("u:only-child")))
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("Underline", callback);
                    } else {
                        this._testToolbarButtonClick("Underline", "", "textToolbar", callback);
                    }
                },
                strikethroughed: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return ((this.css("textDecoration").indexOf("line-through") !== -1) ||
                            (this.children().first().css("textDecoration").indexOf("line-through") !== -1) ||
                            ((this.find("strike:only-child")))
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("Strikethrough", callback);
                    } else {
                        this._testToolbarButtonClick("Strikethrough", "", "textToolbar", callback);
                    }
                },
                justifyLeft: function (useExecAction) {
                    var callback = function (iframeBody) {
                        //Chrome default textAlign value is start.
                        return this.css("textAlign") === "left" || this.css("textAlign") === "start";
                    };

                    if (useExecAction) {
                        this._testExecuteAction("justifyleft", callback);
                    } else {
                        this._testToolbarButtonClick("justifyleft", "", "formattingToolbar", callback);
                    }
                },
                justifyCenter: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return this.css("textAlign") === "center";
                    };

                    if (useExecAction) {
                        this._testExecuteAction("justifycenter", callback);
                    } else {
                        this._testToolbarButtonClick("justifycenter", "", "formattingToolbar", callback);
                    }
                },
                justifyRight: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return this.css("textAlign") === "right";
                    };

                    if (useExecAction) {
                        this._testExecuteAction("justifyright", callback);
                    } else {
                        this._testToolbarButtonClick("justifyright", "", "formattingToolbar", callback);
                    }
                },
                justifyFull: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return this.css("textAlign") === "justify";
                    };

                    if (useExecAction) {
                        this._testExecuteAction("justifyfull", callback);
                    } else {
                        this._testToolbarButtonClick("justifyfull", "", "formattingToolbar", callback);
                    }
                },
                insertUnorderedList: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return (this.parents().length === 0 && iframeBody.find("ul").length === 1 //Mozilla
                            ||
                            this.children(":first").is("ul") // chrome
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("InsertUnorderedList", callback);
                    } else {
                        this._testToolbarButtonClick("InsertUnorderedList", "", "formattingToolbar", callback);
                    }
                },
                insertOrderedList: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return (this.parents().length === 0 && iframeBody.find("ol").length === 1 ||
                            this.children(":first").is("ol") // chrome
                        );
                    };

                    if (useExecAction) {
                        this._testExecuteAction("InsertOrderedList", callback)
                    } else {
                        this._testToolbarButtonClick("InsertOrderedList", "", "formattingToolbar", callback);
                    }
                },
                indentText: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return this.css("margin-left") === "40px" || (iframeBody.find("blockquote > p").length === 1 && iframeBody.find("blockquote").css("margin-left") === "40px");
                    };

                    if (useExecAction) {
                        this._testExecuteAction("indent", callback);
                    } else {
                        this._testToolbarButtonClick("indent", "", "formattingToolbar", callback);
                    }
                },
                outdentText: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return this.css("margin-left") === "0px" || (iframeBody.find("blockquote > p").length === 1 && iframeBody.find("blockquote").css("margin-left") === "0px");
                    };

                    this.indentText();
                    if (useExecAction) {
                        this._testExecuteAction("outdent", callback);
                    } else {
                        this._testToolbarButtonClick("outdent", "", "formattingToolbar", callback);
                    }
                },
                colorText: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return (this.css("color") === "rgb(255, 0, 0)" //Mozilla FF
                            ||
                            this.children(":first").css("color") === "rgb(255, 0, 0)"); //IE, Chtome
                    };

                    if (useExecAction) {
                        this._testExecuteAction("forecolor", callback, 'red');
                    } else {
                        this._testToolbarButtonClick("textColor", "textColor", "formattingToolbar", callback);
                    }
                },
                buttonCombinationsTest: function () {
                    var i, buttonsNames = arguments;
                    for (i = 0; i < buttonsNames.length; i++) {
                        if ($.isFunction(this[buttonsNames[i]])) {
                            this[buttonsNames[i]]();
                        }
                    }
                },
                removeIndentFromText: function () { },
                changeFontName: function (useExecAction) {
                    var callback = function () {
                        return this.children(":first").css("fontFamily") === "Helvetica";
                    };

                    if (useExecAction) {
                        this._testExecuteAction("fontname", callback, 'Helvetica');
                    } else {
                        this._testIgCombo("fontFamily", "textToolbar", 3, callback);
                    }
                },
                changeFontSize: function (useExecAction) {
                    var callback = function () {
                        return (this.children(":first").css("fontSize") === "18px" //Chrome, FF
                                ||
                                this.children(":first").css("fontSize") === "18.06px") //IE
                    };

                    if (useExecAction) {
                        // the param 4 === font-size: large === 18px
                        this._testExecuteAction("fontSize", callback, 4);
                    } else {
                        this._testIgCombo("fontSize", "textToolbar", 3, callback);
                    }
                },
                changeBackgroundColor: function () {
                    var callback = function () {
                        return (this.children(":first").css("background-color") === "rgb(255, 0, 0)")
                    };

                    this._testExecuteAction("backcolor", callback, "red");
                },
                changeBackgroundColorWithInteraction: function () {
                    // Test with click button interaction
                    var self = this, p = this.editorBody.find("p:first"), button = $("#" + this.htmlEditorId + "_toolbars_formattingToolbar_item_backgroundTextColor_arrow");

                    stop();
                    setTimeout(function () {
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        start();
                    }, 100);

                    stop();
                    setTimeout(function () {
                        button.trigger("click");
                        start();
                    }, 100);

                    stop();
                    setTimeout(function () {
                        // Click on red color, Red  === 'rgb(255, 0, 0)'
                        $($($(".ui-colorpicker-standardcolors")[1]).find(".igColorPicker-color")[1]).click();
                        start();
                    }, 100);

                    stop();
                    setTimeout(function () {
                        button.trigger("click");
                        start();
                    }, 100);

                    stop();
                    setTimeout(function () {
                        $("#" + this.htmlEditorId + "_toolbars_formattingToolbar_item_backgroundTextColor_backgroundTextColor").click();

                        ok(p.children().css("background-color") === "rgb(255, 0, 0)", "Selected text background color is changed to red, rgb(255, 0, 0)");
                        start();
                    }, 300);
                },
                manipulateDomPathToolbarButton: function () {
                    // Test with click button interaction
                    var self = this, button = $("#" + this.htmlEditorId + "_toolbars_formattingToolbar_item_backgroundTextColor_arrow"), td, domPathToolbar,
                    viewStateBtn = this.htmlEditor.find(".ui-igbutton-viewsource");

                    this.htmlEditor.igHtmlEditor("setContent", "<table border='1'><tbody><tr><td>asd</td><td>&nbsp;</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table><br><br>", "html");
                    td = $(self.htmlEditor.igHtmlEditor("contentEditable")).find("table tr:nth-child(1) td:nth-child(1)");

                    viewStateBtn.click();

                    stop();
                    setTimeout(function () {
                        start();
                    }, 200);

                    viewStateBtn.click();

                    stop();
                    setTimeout(function () {
                        domPathToolbar = $("#" + self.htmlEditorId + "_domPathToolbar");
                        $(domPathToolbar.find("span")).click();
                        ok($(self.htmlEditor).data().igHtmlEditor._selectionWrapperSaved._document !== undefined, "Document was selected by using domPathToolbar");
                        start();
                    }, 400);
                },
                editorResizeWorkspace: function () {
                    var newDiv = $('<div />').appendTo('body');
                    $(this.htmlEditor).appendTo(newDiv);

                    $(newDiv).css("display", "none");
                    $(this.htmlEditor).data().igHtmlEditor.resizeWorkspace();
                    equal($(this.htmlEditor.data().igHtmlEditor._toolbars).is(":visible"), false, "Toobars are hidden and resized correctly");

                    $(newDiv).css("display", "");
                    equal($(this.htmlEditor.data().igHtmlEditor._toolbars).is(":visible"), true, "Toobars are shown correctly");
                },
                changeHeadingFormat: function (useExecAction) {
                    var callback = function (iframeBody) {
                        return !!iframeBody.find("h3").length;
                    };

                    if (useExecAction) {
                        this._testExecuteAction("formatBlock", callback, 'h3');
                    } else {
                        this._testIgCombo("formatsList", "textToolbar", 2, callback);
                    }
                },
                _testToolbarButtonClick: function (buttonName, splitButtonName, toolbarName, conditionCallBack) {
                    /*
                        Test the result of html toolbar buttons click.
                        paramType="string" The name of the button as it is defined in the html editor options.
                        paramType="function" return="bool". A callback function which scope is the paragraph jq element which is used for the test.
                        paramType="bool"
                    */
                    var self = this,
                        splitButtonName = splitButtonName || "",
                        button = $("#" + this.htmlEditorId + "_toolbars_" + toolbarName + "_item_" + ((splitButtonName === "") ? buttonName : splitButtonName + "_" + buttonName));
                    stop();

                    setTimeout(function () {
                        var p = self.editorBody.find("p:first");
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        button.trigger("click");
                        var condition = false;
                        if ($.isFunction(conditionCallBack)) {
                            condition = conditionCallBack.call(p, self.editorBody);
                        }

                        ok(condition, buttonName + " combo.");
                        start();
                    }, 200);
                },
                _testExecuteAction: function (actionName, conditionCallBack, param) {
                    /*
                        Test the result of html toolbar buttons click.
                        paramType="string" The name of the button as it is defined in the html editor options.
                        paramType="function" return="bool". A callback function which scope is the paragraph jq element which is used for the test.
                        paramType="bool"
                    */
                    var self = this;
                    stop();
                    setTimeout(function () {
                        var p = self.editorBody.find("p:first");
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        self.htmlEditor.igHtmlEditor('executeAction', actionName, param);
                        var condition = false;
                        if ($.isFunction(conditionCallBack)) {
                            condition = conditionCallBack.call(p, self.editorBody);
                        }
                        ok(condition, 'Execute action ' + actionName + " combo.");
                        start();
                    }, 200);
                },
                _testIgCombo: function (name, toolbarName, index, conditionCallBack) {
                    var self = this,
                        combo = $("#" + this.htmlEditorId + "_toolbars_" + toolbarName + "_item_" + name)
                        .igCombo("option", {
                            animationShowDuration: 0,
                            animationHideDuration: 0
                        });
                    var p = null;

                    combo.bind("igcombodropdownopened", function () {
                        //combo.find("ul > li:eq(" + index + ")").trigger("click");
                        combo.igCombo('index', index, null, true);
                    });

                    stop();
                    setTimeout(function () {
                        p = self.editorBody.find("p:first");
                        self.htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(p.contents());
                        combo.igCombo("openDropDown", null, true, true);
                        start();
                    }, 200);

                    $("#" + this.htmlEditorId + "_toolbars_" + toolbarName).bind("igtoolbartoolbarcomboselected", function (e) {
                        var condition = false;
                        stop();
                        setTimeout(function () {
                            if ($.isFunction(conditionCallBack)) {
                                condition = conditionCallBack.call(p, self.editorBody);
                            }
                            combo.igCombo("closeDropDown");
                            ok(condition, name + " combo.");
                            start();
                        }, 200);
                    });
                },
                _openLinkDialog: function () {
                    var button = $("#" + this.htmlEditorId + "_toolbars_insertObjectToolbar_item_link"),
                        dialog,
                        anchorAddress = "http://google.com",
                        self = this;

                    stop();

                    setTimeout(function () {
                        button.trigger("click");

                        dialog = $("#" + self.htmlEditorId + "_linkDialog_popover");
                        dialog.find("#html1_linkDialog_linkHref").val(anchorAddress).end()
                            .find("#html1_linkDialog_btnApply").click();

                        // Reopen the dialog
                        button.trigger("click");
                        dialog.find("#html1_linkDialog_btnCancel").click();

                        // Close it with esc Also
                        button.trigger("click");
                        // Simulate keydown of backspace event
                        var escClickEvent = jQuery.Event("keypress", { keyCode: 27 });
                        dialog.find("div[id*='_contentInner']").trigger(escClickEvent);

                        start();
                    }, 200);



                    $("body").on("iglinkpropertiesdialoghide", function () {
                        var p = self.editorBody.find("p:first"),
                            a = p.find("a");
                        ok(a.length === 1, "The anchor element is inserted properly.");

                        ok(a.html() === anchorAddress, "The anchor element display text.");
                        ok(a.attr("href") === anchorAddress, "The anchor element display text.");
                    });

                    // Reopen and close the window
                    setTimeout(function () {
                        button.trigger("click");
                    }, 200);
                },
                _openImageDialog: function () {
                    var button = $("#" + this.htmlEditorId + "_toolbars_insertObjectToolbar_item_image"),
                        dialog,
                        imageURL = "http://www.hausmeisterservice-peukert.de/pictures/baum8.jpg",
                        imageAlt = "image test",
                        self = this;
                    stop();

                    setTimeout(function () {

                        button.trigger("click");

                        dialog = $("#" + self.htmlEditorId + "_imageDialog_popover");

                        dialog.find("#html1_imageDialog_imgSrc").val(imageURL).end()
                            .find("#html1_imageDialog_imgAlt").val(imageAlt).end()
                            .find("#html1_imageDialog_btnApply").click();


                        // Reopen the image dialog
                        button.trigger("click");
                        dialog.find("#html1_imageDialog_imgSrc").val(imageURL).end()
                            .find("#html1_imageDialog_imgAlt").val(imageAlt).end()
                            .find("#html1_imageDialog_btnCancel").click();


                        start();
                    }, 200);

                    $("body").on("igimagepropertiesdialoghide", function () {
                        var p = self.editorBody.find("p:first"),
                            img = p.find("img");
                        ok(img.length === 1, "The image element is inserted properly.");
                        ok(img.attr("src") === imageURL, "The image url.");
                        ok(img.attr("alt") === imageAlt, "The image alt text.");
                    })
                },
                _openTableDialog: function () {
                    var button = $("#" + this.htmlEditorId + "_toolbars_insertObjectToolbar_item_table"),
                        dialog, iframeDocument = $($("#" + this.htmlEditorId).data().igHtmlEditor.workspace).contents(),
                        self = this, cell, trCount, tdCount;

                    stop();
                    setTimeout(function () {
                        button.trigger("click");
                        dialog = $("#" + self.htmlEditorId + "_tableDialog_popover");
                        cell = dialog.find(".ui-igtablepropertiesdialog-sample-table tr:nth-child(2) td:nth-child(2)")

                        cell.trigger("mouseover");
                        cell.trigger("mouseout");
                        cell.trigger("mouseover");
                        cell.click();
                        // Reopen the image dialog
                        button.trigger("click");

                        trStaticCount = 2;
                        tdStaticCount = 4;
                        start();
                    }, 200);

                    stop();
                    setTimeout(function(){
                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.select(iframeDocument.find("table tr:nth-child(1) td:nth-child(1)"));

                        var newTable = document.createElement("TABLE"),
                            newRow = newTable.insertRow(0),
                            cell1 = newRow.insertCell(0);


                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.insertTable($(newTable));

                        trCount = iframeDocument.find("table tr").length;
                        tdCount = iframeDocument.find("table td").length;

                        equal(trCount, 3, "Table is inserted crrectly with 3 rows");
                        equal(tdCount, 5, "Table is inserted crrectly with 5 cells.");
                        start();
                    }, 300);

                    stop();
                    setTimeout(function(){
                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.select(iframeDocument.find("table"));

                        var newTable = document.createElement("TABLE"),
                            newRow = newTable.insertRow(0),
                            cell1 = newRow.insertCell(0);


                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.insertTable($(newTable));

                        trCount = iframeDocument.find("table tr").length;
                        tdCount = iframeDocument.find("table td").length;

                        equal(trCount, 1, "Table is cleared");
                        equal(tdCount, 1, "Table is cleared");
                        start();
                    }, 400);

                    stop();
                    setTimeout(function(){
                        $("#html1").igHtmlEditor('setContent', '<br />', 'html');
                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.select(iframeDocument.find("br"));

                        var newTable = document.createElement("TABLE"),
                            newRow = newTable.insertRow(0),
                            cell1 = newRow.insertCell(0);


                        $("#html1").data().igHtmlEditor._selectionWrapperSaved.insertTable($(newTable));

                        trCount = iframeDocument.find("table tr").length;
                        tdCount = iframeDocument.find("table td").length;

                        equal(trCount, 1, "Table is cleared");
                        equal(tdCount, 1, "Table is cleared");
                        start();
                    }, 500);

                    $("body").on("igtablepropertiesdialoghide", function () {
                        trCount = iframeDocument.find("table tr").length;
                        tdCount = iframeDocument.find("table td").length;

                        equal(trCount, 2, "Table is inserted crrectly with 2 rows");
                        equal(tdCount, 4, "Table is inserted crrectly with 4 cells.");
                    });
                },
                _addRemoveRowsColumns: function () {
                    var htmlEditor = $("#" + this.htmlEditorId),
                        addRowButton = $("#" + this.htmlEditorId + "_toolbars_insertObjectToolbar_item_addRow"),
                        addColumnButton = $("#" + this.htmlEditorId + "_toolbars_insertObjectToolbar_item_addColumn"),
                        dialog, iframeDocument = $($("#" + this.htmlEditorId).data().igHtmlEditor.workspace).contents(),
                        viewStateBtn = htmlEditor.find(".ui-igbutton-viewsource"),
                        self = this;

                    htmlEditor.igHtmlEditor("setContent", "<table border='1'><tbody><tr><td>asd</td><td>&nbsp;</td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table><br><br>", "html");

                    stop();
                    setTimeout(function () {
                        var trCount, tdCount, td;

                        // When <table> element is selected
                        // Add table row
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select($(htmlEditor.igHtmlEditor("contentEditable")).find("table"));
                        htmlEditor.data().igHtmlEditor._addTableRowPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 3, "Table is inserted crrectly with 3 rows, trCount " + trCount);
                        ok(tdCount === 6, "Table is inserted crrectly with 6 cells, tdCount " + tdCount);

                        // Add table column for table selector
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select($(htmlEditor.igHtmlEditor("contentEditable")).find("table"));
                        htmlEditor.data().igHtmlEditor._addTableColumnPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 3, "Table is modified crrectly with 3 rows, trCount " + trCount);
                        ok(tdCount === 9, "Table is modified crrectly with 9 cells, tdCount " + tdCount);

                        // Remove table row for table selector
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select($(htmlEditor.igHtmlEditor("contentEditable")).find("table"));
                        htmlEditor.data().igHtmlEditor._removeTableRowPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 2, "Table is modified crrectly with 3 rows, trCount " + trCount);
                        ok(tdCount === 6, "Table is modified crrectly with 6 cells, tdCount " + tdCount);

                        // Remove table column for table selector
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select($(htmlEditor.igHtmlEditor("contentEditable")).find("table"));
                        htmlEditor.data().igHtmlEditor._removeTableColumnPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 2, "Table is modified crrectly with 1 rows, trCount " + trCount);
                        ok(tdCount === 4, "Table is modified crrectly with 3 cells, tdCount " + tdCount);

                        // When <td> element is selected
                        // Add table row
                        td = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr:nth-child(1) td:nth-child(1)")

                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(td);
                        htmlEditor.data().igHtmlEditor._addTableRowPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 3, "Table is modified crrectly with 2 rows, trCount " + trCount);
                        ok(tdCount === 6, "Table is modified crrectly with 6 cells, tdCount " + tdCount);

                        // Add table column for td selector
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(td);
                        htmlEditor.data().igHtmlEditor._addTableColumnPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 3, "Table is modified crrectly with 2 rows, trCount " + trCount);
                        ok(tdCount === 9, "Table is modified crrectly with 8 cells, tdCount " + tdCount);

                        // Remove table row for td selector
                        td = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr:nth-child(1) td:nth-child(1)");
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(td);
                        htmlEditor.data().igHtmlEditor._removeTableRowPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 2, "Table is modified crrectly with 3 rows, trCount " + trCount);
                        ok(tdCount === 6, "Table is modified crrectly with 6 cells, tdCount " + tdCount);

                        // Remove table column for td selector
                        td = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr:nth-child(1) td:nth-child(1)");
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(td);
                        htmlEditor.data().igHtmlEditor._removeTableColumnPlg();

                        trCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table tr").length;
                        tdCount = $(htmlEditor.igHtmlEditor("contentEditable")).find("table td").length;

                        ok(trCount === 2, "Table is modified crrectly with 1 rows, trCount " + trCount);
                        ok(tdCount === 4, "Table is modified crrectly with 3 cells, tdCount " + tdCount);

                        start();
                    }, 100);
                },
                _testSelectionFunctionality: function () {
                    var htmlEditor = $("#" + this.htmlEditorId),
                        iframeDocument = $($("#" + this.htmlEditorId).data().igHtmlEditor.workspace).contents(),
                        self = this;
                    $.ig.util.isIE = true;


                    htmlEditor.igHtmlEditor("setContent", "<i>Some content</i>", "html");

                    stop();
                    setTimeout(function () {
                        contentToSelect = $(htmlEditor.igHtmlEditor("contentEditable")).parent().find("body i");
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved._getTextNodesOnlyCallback();
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(contentToSelect.contents());

                        $.browser = { "IE": "IE"};
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved._commands.insertunorderedlist.browsers = ["IE", "Chrome"];
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.execCommand("insertunorderedlist", null);
                        equal(htmlEditor.igHtmlEditor("getContent", "html"), '<ul><li><i>Some content</i><br></li></ul>', "Content changed to have unordered list");

                        $.browser = undefined;
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.execCommand("insertunorderedlist", null);
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.execCommand("bold", null);

                        equal(htmlEditor.igHtmlEditor("getContent", "html"), '<i style=\"font-weight: bold;\">Some content</i><br>', "Content remains the same");
                        start();
                    }, 200);

                    stop();
                    setTimeout(function (){
                        htmlEditor.igHtmlEditor("setContent", "<div id='div1'>Some content1<div>Some content2<div>Some content3<div><div><div>", "html");
                        contentToSelect = $(htmlEditor.igHtmlEditor("contentEditable")).parent().find("body #div1");
                        htmlEditor.data("igHtmlEditor")._selectionWrapperSaved.select(contentToSelect.contents());
                        var nodes = htmlEditor.data("igHtmlEditor")._selectionWrapperSaved._findAllTextNodes(contentToSelect);
                        equal(nodes.length, 3, "Three nodes are returned");

                        start();
                    }, 300);

                    stop();
                    setTimeout(function (){
                        htmlEditor.igHtmlEditor("setContent", "<div id='div1'>Some new content<div>", "html");
                        contentToWrap = $(htmlEditor.igHtmlEditor("contentEditable")).parent().find("body #div1");

                        var textNode = htmlEditor.data("igHtmlEditor")._selectionWrapperSaved._wrapPartialString("Some", 2, 6, contentToWrap);
                        equal($($(textNode)[0]).text() + $($(textNode)[1]).text(), "Some", "Text node returned");

                        start();
                    }, 300);

                },
                _testInsertElement: function () {
                    var htmlEditor = $("#" + this.htmlEditorId),
                        iframeDocument = $($("#" + this.htmlEditorId).data().igHtmlEditor.workspace).contents(),
                        self = this;
                    $.ig.util.isIE = true;

                    htmlEditor.igHtmlEditor("setContent", "<div id='div1'>Some content1<div><p id='div2'>Some content2<p>", "html");
                    contentToSelect = $(htmlEditor.igHtmlEditor("contentEditable")).parent().find("body #div1");

                    stop();
                    setTimeout(function (){
                        $("#" + self.htmlEditorId).data().igHtmlEditor._analyser._disableTableControls(false);
                        var surroundContentsDiv = $($("#" + self.htmlEditorId).igHtmlEditor("contentEditable")).parent().find("body #div2");
                        $("#" + self.htmlEditorId).data("igHtmlEditor")._selectionWrapperSaved.select(contentToSelect.contents());

                        $("#" + self.htmlEditorId).data("igHtmlEditor")._selectionWrapperSaved.insertElement(surroundContentsDiv);
                        $("#" + self.htmlEditorId).data("igHtmlEditor")._selectionWrapperSaved.getSelectedItem();

                        equal($("#" + self.htmlEditorId).igHtmlEditor("getContent","html"), '<div id=\"div1\"><p id=\"div2\">Some content2</p>Some content1<div><p></p></div></div>', "Node inserted");

                        start();
                    }, 200);
                },
            };

            module("HtmlEditor Interaction Tests", htmlEditorInteractionTests);
            test("Bold.", function () {
                this.bold();
            });
            test("Execute Action Bold.", function () {
                this.bold(true);
            });
            test("Italic.", function () {
                this.italic();
            });
            test("Execute Action Italic.", function () {
                this.italic(true);
            });
            test("Underline.", function () {
                this.undelined();
            });
            test("Execute Action Underline.", function () {
                this.undelined(true);
            });
            test("Strikethrough.", function () {
                this.strikethroughed();
            });
            test("Execute Action Strikethrough.", function () {
                this.strikethroughed(true);
            });
            test("Bold, Italic, Underline, Strikethrough", function () {
                this.buttonCombinationsTest("bold", "italic", "undelined", "strikethroughed");
            });
            test("Align text right.", function () {
                this.justifyRight();
            });
            test("Execute Action Align text right.", function () {
                this.justifyRight(true);
            });
            test("Align text left.", function () {
                this.justifyLeft();
            });
            test("Execute Action Align text left.", function () {
                this.justifyLeft(true);
            });
            test("Align text center.", function () {
                this.justifyCenter();
            });
            test("Execute Action Align text center.", function () {
                this.justifyCenter(true);
            });
            test("Justify text.", function () {
                this.justifyFull();
            });
            test("Execute Action Justify text.", function () {
                this.justifyFull(true);
            });
            test("Insert Unordered List.", function () {
                this.insertUnorderedList();
            });
            test("Execute Action Insert Unordered List.", function () {
                this.insertUnorderedList(true);
            });
            test("Insert Ordered List.", function () {
                this.insertOrderedList();
            });
            test("Execute Action Insert Ordered List.", function () {
                this.insertOrderedList(true);
            });
            test("Indent text.", function () {
                this.indentText();
            });
            test("Execute Action Indent text.", function () {
                this.indentText(true);
            });
            test("Outdent text.", function () {
                this.outdentText();
            });
            test("Execute Action Outdent text.", function () {
                this.outdentText(true);
            });
            test("Color text.", function () {
                this.colorText();
            });
            test("Execute Action Color text.", function () {
                this.colorText(true);
            });
            test("Font name.", function () {
                this.changeFontName();
            });
            test("Execute Action Font name.", function () {
                this.changeFontName(true);
            });
            test("Font size.", function () {
                this.changeFontSize();
            });
            test("Execute Action Font size.", function () {
                this.changeFontSize(true);
            });
            test("Execute Action background color.", function () {
                this.changeBackgroundColor();
            });
            test("Execute Action background color with interaction.", function () {
                this.changeBackgroundColorWithInteraction();
            });
            test("Test domPathToolbar buttons", function () {
                this.manipulateDomPathToolbarButton();
            });
            test("resize workspace", function () {
                this.editorResizeWorkspace();
            });
            test("Heading", function () {
                this.changeHeadingFormat();
            });
            test("Execute Action Heading", function () {
                this.changeHeadingFormat(true);
            });
            test("Link dialog", function () {
                this._openLinkDialog();
            });
            test("Image dialog", function () {
                this._openImageDialog();
            });
            test("Table dialog", function () {
                this._openTableDialog();
            });
            test("Add/Remove rows/columns", function () {
                this._addRemoveRowsColumns();
            });
            test("Test selection functionality", function () {
                this._testSelectionFunctionality();
            });
            test("Test surround contents", function () {
                this._testInsertElement();
            });
            module("HtmlEditor Rendering Tests", htmlEditorTestBeds);
            test("Default toolbars rendering.", function () {
                this.areDefaultToolbarsRendered();
            });
            test("Are Text toolbar items rendered?", function () {
                this.areTextToolbarItemsRendered();
            });
            test("Are Formatting toolbar items rendered?", function () {
                this.areFormattingToolbarItemsRendered();
            });
            test("Are Insert Object toolbar items rendered?", function () {
                this.areInsertObjectToolbarItemsRendered();
            });
            test("Are Copy/Paste toolbar items rendered?", function () {
                this.areCopyPasteToolbarItemsRendered();
            });
            test("Text toolbar collapsed.", function () {
                this.isToolbarCollapsible("textToolbar");
            });
            test("Text toolbar expanded.", function () {
                this.isToolabrExpandable("textToolbar");
            });
            test("Formattubg toolbar collapsed.", function () {
                this.isToolbarCollapsible("formattingToolbar");
            });
            test("Formattubg toolbar expanded.", function () {
                this.isToolabrExpandable("formattingToolbar");
            });
            test("Insert Object toolbar collapsed.", function () {
                this.isToolbarCollapsible("insertObjectToolbar");
            });
            test("Insert Object toolbar expanded.", function () {
                this.isToolabrExpandable("insertObjectToolbar");
            });
            test("Copy/Paste toolbar collapsed.", function () {
                this.isToolbarCollapsible("copyPasteToolbar");
            });
            test("Copy/Paste toolbar expanded.", function () {
                this.isToolabrExpandable("copyPasteToolbar");
            });
            test("Workspace area rendered.", function () {
                this.isContentAreaRenderedProperly();
            });
            test("Initial content rendering", function () {
                this.initialContentRendering();
            });
            test("Modify initially set options", function () {
                this.modifyInitiallySetOptions();
            });
            test("Focus node type checker simulating IE Browser", function (){
                this.focuseIframeIEBrowserNodeTypeCheck();
            });
            test("Execute command node type set to text checker simulating IE Browser", function () {
                this.executeCommandIeBrowserNodeTypeTextCheck();
            });
            test("Execute command node type not set text checker simulating IE Browser", function () {
                this.executeCommandIeBrowserNodeTypeNotTextCheck();
            });
            test("Test some different keyboard interactions", function () {
                this.keyboardInteractions();
            });
            test("Insert at caret position", function () {
                this.insertAtCaretPosition();
            });
            test("Adjust domPathToolbar width when max width is reached", function () {
                this.adjustDomPathToolbarWidth();
            });

            var igHtmlEditorPopoverUnitTestsSetup = {
                targetId: 'targetId',
                targetSelector: "#targetId",
                popOverId: 'popOverId',
                popOverSelector: "#popOverId",
                setup: function () {
                    $('body').append('<div id=' + this.targetId + '></div><div id=' + this.popOverId + '></div>');
                    $(this.popOverSelector).igHtmlEditorPopover({
                        target: $(this.targetSelector)
                    });

                    this.actualPopOver = $(this.popOverSelector).data().igHtmlEditorPopover;


                },
                teardown: function () {
                    $(this.popOverSelector).remove();
                    $(this.targetSelector).remove();
                }
            }

            module("igHtmlEditorPopover unit tests", igHtmlEditorPopoverUnitTestsSetup);

            test("test _setOptions method with name isHidden", function () {
                $(this.popOverSelector).igHtmlEditorPopover('option', 'isHidden', true);

                var actualResult = $(this.popOverSelector).igHtmlEditorPopover('option', 'isHidden');
                var expectedResult = true;

                equal(actualResult, expectedResult, "should be set to true");
            });

            var igHtmlEditorTestSetup = {
                htmlEditorId: "htmlEditor2",
                htmlEditorSelector: "#htmlEditor2",
                setup: function () {
                    $('body').append("<div id=" + this.htmlEditorId + "></div>");
                    $(this.htmlEditorSelector).igHtmlEditor();
                },
                teardown: function () {
                    $(this.htmlEditorSelector).igHtmlEditor("destroy").remove();
                }
            };

            module("igHtmlEditor unit tests", igHtmlEditorTestSetup);

            test("getOption testing for width", function () {
                var actualWidth = $(this.htmlEditorSelector).igHtmlEditor("option", "width");

                equal(actualWidth, 725, "This should be default");
            });

            test("setOption testing for width", function () {
                var actualWidth,
                    expectedWidth = 725;
                $(this.htmlEditorSelector).igHtmlEditor("option", "width", expectedWidth);
                actualWidth = $(this.htmlEditorSelector).igHtmlEditor("option", "width");

                equal(actualWidth, expectedWidth, "This should be default");
            });


            var igLinkPropertiesDialogTestSetup = {
                linkTargerId: "linkTarket",
                linkTargerSelector: "#linkTarket",
                setup: function () {
                    $('body').append("<div id=" + this.linkTargerId + "></div>");
                    $(this.linkTargerSelector).igLinkPropertiesDialog({
                        item: $(this.linkTargerSelector),
                        target: $(this.linkTargerSelector),
                    });
                },
                teardown: function () {
                    $(this.linkTargerSelector).igLinkPropertiesDialog("destroy").remove();
                }
            };

            module("igLinkPropertiesDialogTestSetup unit tests", igLinkPropertiesDialogTestSetup);

            test("igLinkPropertiesDialog initializing", function () {
                var initialized = $(this.linkTargerSelector).length > 0;
                equal(initialized, true, "Should be true");
            });

            var igTablePropertiesDialogTestSetup = {
                igTableId: "table",
                igTableSelector: "#table",
                setup: function () {
                    $('body').append("<table id=" + this.igTableId + "></table>");
                    $(this.igTableSelector).igTablePropertiesDialog({
                        item: $(this.igTableSelector),
                        target: $(this.igTableSelector)
                    });
                },
                teardown: function () {
                    $(this.igTableSelector).igTablePropertiesDialog("destroy").remove();
                }
            };

            module("igTablePropertiesDialog unit tests", igTablePropertiesDialogTestSetup);

            test("igTablePropertiesDialog initializing", function () {
                var initialized = $(this.igTableSelector + "_popover").length > 0;
                equal(initialized, true, "Should be true");
            });

            var igImagePropertiesDialogTestSetup = {
                igImageId: "image",
                igImageSelector: "#image",
                setup: function () {
                    $('body').append("<div id=" + this.igImageId + "></div>");
                    $(this.igImageSelector).igImagePropertiesDialog({
                        item: $(this.igImageSelector),
                        target: $(this.igImageSelector)
                    });
                },
                teardown: function () {
                    $(this.igImageSelector).igImagePropertiesDialog("destroy").remove();
                }
            };

            module("igImagePropertiesDialog unit tests", igImagePropertiesDialogTestSetup);

            test("igImagePropertiesDialog initializing", function () {
                var initialized = $(this.igImageSelector + "_popover").length > 0;
                equal(initialized, true, "Should be true");
            });

            var igToolbarHelperTestSetup = {
                editorId: "htmlEditor3",
                editorSelector: "#htmlEditor3",
                setup: function () {
                    $('body').append("<div id=" + this.editorId + "></div>");
                    $(this.editorSelector).igHtmlEditor();
                },
                teardown: function () {
                    $(this.editorSelector).igHtmlEditor("destroy").remove();
                }
            }

            module("igToolbarHelper unit tests", igToolbarHelperTestSetup);

            test("QueryCommandState with left, right, center and full justify", function () {
                var self = this;
                var content = $("<p align='left'>test</p>");
                $(this.editorSelector).igHtmlEditor("setContent", content, "html");
                stop();
                setTimeout(function () {
                    var selectionWrapperSaved = $(self.editorSelector).data("igHtmlEditor")._selectionWrapperSaved;
                    var analyser = $(self.editorSelector).data("igHtmlEditor")._analyser;
                    var contentDoc = $(self.editorSelector).igHtmlEditor("contentDocument");
                
                    // justify left
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("justifyleft"), true, "The query command state should be left justified.");
                
                    // justify right
                    content = $("<p align='right'>test</p>");
                    $(self.editorSelector).igHtmlEditor("setContent", content, "html");
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("justifyright"), true, "The query command state should be right justified.");

                    // justify center
                    content = $("<p align='center'>test</p>");
                    $(self.editorSelector).igHtmlEditor("setContent", content, "html");
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("justifycenter"), true, "The query command state should be center justified.");
                
                    // justify full
                    content = $("<p align='justify'>test</p>");
                    $(self.editorSelector).igHtmlEditor("setContent", content, "html");
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("justifyfull"), true, "The query command state should be full justified.");

                    start();
                }, 100);
            });

            test("QueryCommandState with ordered and unordered lists", function () {
                var self = this;
                var content = $("<ol><li>first</li><li>second</li></ol>");
                $(this.editorSelector).igHtmlEditor("setContent", content, "html");
                stop();
                setTimeout(function () {
                    var selectionWrapperSaved = $(self.editorSelector).data("igHtmlEditor")._selectionWrapperSaved;
                    var analyser = $(self.editorSelector).data("igHtmlEditor")._analyser;
                    var contentDoc = $(self.editorSelector).igHtmlEditor("contentDocument");

                    // ordered list
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("insertorderedlist"), true, "The query command state should be insert ordered list.");

                    // unordered list
                    content = $("<ul><li>first</li><li>second</li></ul>");
                    $(self.editorSelector).igHtmlEditor("setContent", content, "html");
                    selectionWrapperSaved.select(content);
                    analyser.analyse(selectionWrapperSaved.getSelectedItem());
                    equal(contentDoc.queryCommandState("insertunorderedlist"), true, "The query command state should be insert unordered list.");

                    start();
                }, 100);
            });


            test("Add image to editor with no errors in IE", function () {
                var self = this, image, editor, input, htmlEditorElement = $(this.editorSelector),
                    button = htmlEditorElement.find("#" + this.editorId + "_toolbars_insertObjectToolbar_item_image"),
                    imageURL = "http://www.hausmeisterservice-peukert.de/pictures/baum8.jpg";

                stop();
                setTimeout(function () {                   
                    button.trigger("click");
                    setTimeout(function () {
                        start();
                        input = $("#" + self.editorId + "_imageDialog_imgSrc");
                        input.val(imageURL);
                        button = $("#" + self.editorId + "_imageDialog_btnApply");
                        button.click();
                        stop();
                        setTimeout(function () {
                            start();
                            editor = htmlEditorElement.data().igHtmlEditor;
                            image = $(editor.contentEditable()).find("img");
                            equal(image.length, 1, "The image should appear into content of the editor.");
                            stop();
                            setTimeout(function () {
                                start();
                            }, 200);
                        }, 200);                        
                    }, 200);                    
                }, 200);       
            });
        </script>
    </head>
    <body>
        <!--    <div id="qunit"></div>
        <div id="qunit-fixture"></div>-->
        <div style="float:right;width:400px;overflow:auto;">
            <h1 id="qunit-header">Test results</h1>
            <h2 id="qunit-banner"></h2>
            <h2 id="qunit-userAgent"></h2>
            <ol id="qunit-tests"></ol>
        </div>
    </body>
</html>
